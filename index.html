<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebChat Deluxe V1.1.8</title>
<style>
  body { font-family: Arial,sans-serif; background:#f1f5f9; margin:0; padding:0; }
  .container { display:flex; max-width:1200px; margin:20px auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  .sidebar { width:300px; border-right:1px solid #ddd; padding:16px; background:#fff; }
  .main { flex:1; padding:16px; display:flex; flex-direction:column; }
  h2,h3,h4{margin-top:0;margin-bottom:8px;}
  input,button,select{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px;}
  button{cursor:pointer;background:#2563eb;color:#fff;border:none;}
  button:hover{background:#1e40af;}
  .chat-box{flex:1; overflow-y:auto; border:1px solid #ddd; border-radius:6px; padding:8px; background:#fafafa; display:flex; flex-direction:column; gap:6px;}
  .message{max-width:70%;padding:6px 8px;border-radius:6px; word-wrap: break-word;}
  .sent{background:#dbeafe;align-self:flex-end;}
  .received{background:#f3f4f6;align-self:flex-start;}
  img.chat-img{max-width:200px;border-radius:6px;}
  .sidebar div{margin-bottom:4px;}
  .sidebar div:hover{background:#f3f4f6; cursor:pointer;}
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>WebChat Deluxe V1.1.8</h2>
    <div id="authArea">
      <input type="email" id="email" placeholder="E-Mail"><br><br>
      <input type="password" id="password" placeholder="Passwort"><br><br>
      <button type="button" onclick="signup()">Registrieren</button>
      <button type="button" style="margin-top:8px;background:#059669" onclick="login()">Anmelden</button>
    </div>

    <div id="userArea" style="display:none;">
      <div id="userInfo"></div>
      <button type="button" style="background:#dc2626;margin-top:8px" onclick="logout()">Abmelden</button>
      <hr/>
      <h4>Kontakte</h4>
      <div id="contacts"></div>
      <input id="addContactInput" placeholder="Name hinzufügen"><br>
      <button type="button" style="margin-top:6px" onclick="addContactByName()">Hinzufügen</button>
      <hr/>
      <h4>Gruppen</h4>
      <div id="groups"></div>
      <input id="newGroupName" placeholder="Gruppenname"><br>
      <button type="button" style="margin-top:6px" onclick="createGroup()">Erstellen</button>
    </div>
  </div>

  <div class="main">
    <div id="chatHeader"><h3>Bitte anmelden</h3></div>
    <div id="chatBox" class="chat-box"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <input id="messageInput" placeholder="Nachricht..." style="flex:1">
      <input type="file" id="imageInput" accept="image/*">
      <button type="button" onclick="sendMessage()">Senden</button>
      <button type="button" id="sendImageBtn">Bild senden</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
    authDomain: "webchat-a47cc.firebaseapp.com",
    databaseURL: "https://webchat-a47cc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "webchat-a47cc",
    storageBucket: "webchat-a47cc.firebasestorage.app",
    messagingSenderId: "318380716143",
    appId: "1:318380716143:web:da7474bfa392dfeaccdd9a",
    measurementId: "G-GBFBS5F8GB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatHeader = document.getElementById('chatHeader');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const sendImageBtn = document.getElementById('sendImageBtn');

let me = null;
let selectedPeer = null;

// --- Notifications + Sound ---
let notifyAllowed = false;
const messageSound = new Audio('https://www.soundjay.com/button/beep-07.mp3');

async function requestNotificationPermission() {
    if (!("Notification" in window)) {
        alert("Dieser Browser unterstützt keine Benachrichtigungen.");
        return false;
    }
    if (Notification.permission === "granted") return true;
    const permission = await Notification.requestPermission();
    return permission === "granted";
}
requestNotificationPermission().then(granted => { notifyAllowed = granted; });

function showNotification(title, body) {
    if (!notifyAllowed) return;
    new Notification(title, { body });
    messageSound.play().catch(e => console.log("Sound konnte nicht abgespielt werden:", e));
}

// --- Auth State ---
onAuthStateChanged(auth, async user=>{
    if(user){
        me = { uid:user.uid, email:user.email, name:user.email.split('@')[0] };
        await setDoc(doc(db,'users',me.uid), me, {merge:true});
        authArea.style.display='none';
        userArea.style.display='block';
        userInfo.textContent=`Angemeldet als ${me.name}`;
        loadContacts();
        loadGroups();
        chatHeader.innerHTML='<h3>Wähle einen Chat</h3>';
    } else {
        me=null;
        authArea.style.display='block';
        userArea.style.display='none';
        chatHeader.innerHTML='<h3>Bitte anmelden</h3>';
        chatBox.innerHTML='';
    }
});

// --- Auth ---
window.signup = async ()=>{
    const email=document.getElementById('email').value;
    const pw=document.getElementById('password').value;
    if(!email||!pw){alert("E-Mail + Passwort angeben");return;}
    try{ await createUserWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
};
window.login = async ()=>{
    const email=document.getElementById('email').value;
    const pw=document.getElementById('password').value;
    if(!email||!pw){alert("E-Mail + Passwort angeben");return;}
    try{ await signInWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
};
window.logout = async ()=>{ await signOut(auth); selectedPeer=null; chatBox.innerHTML=''; };

// --- Kontakte laden ---
async function loadContacts(){
    contactsDiv.innerHTML='';
    const q=query(collection(db,'users'));
    const snap=await getDocs(q);
    snap.forEach(docu=>{
        const u=docu.data();
        if(u.uid!==me.uid){
            const div=document.createElement('div');
            div.textContent=u.name;
            div.onclick=()=>{ selectedPeer={type:'user',id:u.uid,name:u.name}; loadChat(); };
            contactsDiv.appendChild(div);
        }
    });
}

// --- Gruppen laden ---
async function loadGroups(){
    groupsDiv.innerHTML='';
    const q=query(collection(db,'groups'), where('members','array-contains',me.uid));
    const snap=await getDocs(q);
    snap.forEach(docu=>{
        const g=docu.data();
        const div=document.createElement('div');
        div.textContent=g.name;
        div.onclick=()=>{ selectedPeer={type:'group',id:docu.id,name:g.name}; loadChat(); };
        groupsDiv.appendChild(div);
    });
}

// --- Kontakte hinzufügen ---
window.addContactByName = async ()=>{
    const name=document.getElementById('addContactInput').value.trim();
    if(!name){alert('Name angeben'); return;}
    const q=query(collection(db,'users'),where('name','==',name));
    const snap=await getDocs(q);
    if(snap.empty){alert('Nutzer nicht gefunden'); return;}
    alert('Kontakt kann jetzt für private Gruppen genutzt werden.');
};

// --- Gruppen erstellen ---
window.createGroup = async ()=>{
    const name = document.getElementById('newGroupName').value.trim();
    if(!name) return alert('Gruppenname angeben');
    const emails = prompt("E-Mail-Adressen der Mitglieder (komma-getrennt)").split(',').map(s=>s.trim());
    const membersUIDs = [];
    for(const email of emails){
        const q = query(collection(db,'users'), where('email','==',email));
        const snap = await getDocs(q);
        if(!snap.empty) membersUIDs.push(snap.docs[0].id);
    }
    membersUIDs.push(me.uid);
    await addDoc(collection(db,'groups'), {name, members: membersUIDs});
    loadGroups();
    alert('Private Gruppe erstellt!');
};

// --- Chat laden ---
async function loadChat(){
    if(!selectedPeer){ chatHeader.innerHTML='<h3>Wähle einen Chat</h3>'; return;}
    chatHeader.innerHTML=`<h3>${selectedPeer.name}</h3>`;
    chatBox.innerHTML='';
    let messagesQuery;
    if(selectedPeer.type==='user'){
        messagesQuery=query(collection(db,'messages'), orderBy('timestamp'));
    } else if(selectedPeer.type==='group'){
        messagesQuery=query(collection(db,'messages'), where('to','==',selectedPeer.id), orderBy('timestamp'));
    }

    onSnapshot(messagesQuery,snap=>{
        chatBox.innerHTML='';
        snap.forEach(docu=>{
            const m=docu.data();
            if(selectedPeer.type==='user'){
                if((m.from===me.uid && m.to===selectedPeer.id)||(m.from===selectedPeer.id && m.to===me.uid)){
                    renderMessage(m);
                    if(m.from !== me.uid) showNotification(selectedPeer.name, m.type==='text'?m.text:"Bildnachricht");
                }
            } else if(selectedPeer.type==='group'){
                if(m.to===selectedPeer.id) {
                    renderMessage(m);
                    if(m.from !== me.uid) showNotification(selectedPeer.name, m.type==='text'?m.text:"Bildnachricht");
                }
            }
        });
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}

// --- Nachrichten rendern ---
function renderMessage(m){
    if(m.type==='image'){
        const img=document.createElement('img');
        img.src=m.url;
        img.className='chat-img message '+(m.from===me.uid?'sent':'received');
        chatBox.appendChild(img);
    } else {
        const div=document.createElement('div');
        div.textContent=m.text;
        div.className='message '+(m.from===me.uid?'sent':'received');
        chatBox.appendChild(div);
    }
}

// --- Text senden ---
window.sendMessage = async ()=>{
    if(!selectedPeer){alert('Chat auswählen'); return;}
    const text=messageInput.value.trim();
    if(!text) return;
    await addDoc(collection(db,'messages'), {from:me.uid,to:selectedPeer.id,type:'text',text,timestamp:Date.now()});
    messageInput.value='';
};

// --- Bild senden direkt ---
window.sendImage = async () => {
    if(!selectedPeer){alert('Chat auswählen'); return;}
    const file = imageInput.files[0];
    if(!file){alert('Keine Datei gewählt'); return;}
    
    try {
        const cleanName = file.name.replace(/[^\w.-]/g, "_");
        const storageRef = ref(storage, `chatImages/${me.uid}_${Date.now()}_${cleanName}`);
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snapshot.ref);

        await addDoc(collection(db,'messages'), {
            from: me.uid,
            to: selectedPeer.id,
            type: 'image',
            url,
            timestamp: Date.now()
        });
        imageInput.value = '';
    } catch(err) {
        console.error(err);
        alert("Fehler beim Upload: " + err.message);
    }
};

sendImageBtn.addEventListener('click', sendImage);

</script>

</body>
</html>
