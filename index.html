<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebChat Deluxe V1.4.5</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="sidebar" id="sidebar">
    <h2>WebChat Deluxe <small style="font-weight:600">V1.4.5</small></h2>

    <div id="authArea">
      <input id="email" type="email" placeholder="E-Mail">
      <input id="password" type="password" placeholder="Passwort">
      <div style="display:flex;gap:8px">
        <button onclick="signup()">Registrieren</button>
        <button onclick="login()" style="background:#1d4ed8">Anmelden</button>
      </div>
    </div>

    <div id="userArea" style="display:none">
      <div id="userInfo" class="muted">â€”</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button onclick="logout()" style="background:#ef4444">Abmelden</button>
        <button id="myProfileBtn" class="small-btn" onclick="showProfile()">Profil</button>
      </div>

      <hr style="border:none;height:8px"/>

      <h4>Kontakte</h4>
      <div class="contacts" id="contacts"></div>
      <input id="addContactInput" type="text" placeholder="Name hinzufÃ¼gen">
      <button onclick="addContactByName()">Kontakt anlegen</button>

      <hr style="border:none;height:8px"/>

      <h4>Gruppen</h4>
      <div class="groups" id="groups"></div>
      <input id="newGroupName" type="text" placeholder="Gruppenname">
      <button onclick="createGroup()">Gruppe erstellen</button>

      <div class="footer-small">Demo: Firestore & Storage werden verwendet. Sicherheitsregeln prÃ¼fen.</div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="chat-header">
      <h3 id="chatTitle">Bitte anmelden</h3>
      <div id="callButtons" style="display:none;gap:8px">
        <button id="audioCallBtn" class="small-btn" title="Audioanruf">ğŸ“</button>
        <button id="videoCallBtn" class="small-btn" title="Videoanruf">ğŸ¥</button>
        <button id="groupVideoBtn" class="small-btn" title="Gruppen-Video (nur Video)">ğŸ‘¥ğŸ¥</button>
        <button id="endCallBtn" class="small-btn" title="Auflegen" style="display:none">âŒ</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box"></div>
    <div id="typingIndicator" class="typing-indicator">Niemand schreibt gerade...</div>

    <div class="input-row">
      <input id="messageInput" type="text" placeholder="Schreib eine Nachricht...">
      <input id="imageInput" type="file" accept="image/*">
      <button onclick="sendMessage()">Senden</button>
      <button id="sendImageBtn" onclick="sendImage()">Bild senden</button>
    </div>
    <img id="previewImg" class="preview-img" style="display:none">

    <div id="videoContainer" style="margin-top:12px">
      <div id="videoGrid" class="video-grid"></div>
    </div>
  </div>
</div>

<!-- Incoming Popup -->
<div id="incomingPopup" class="incoming-popup" style="display:none">
  <h3 id="popupTitle">Eingehender Anruf</h3>
  <p id="popupCaller" class="muted"></p>
  <div style="display:flex;gap:8px">
    <button id="acceptCallBtn">Annehmen</button>
    <button id="declineCallBtn">Ablehnen</button>
  </div>
</div>

<script type="module">
// =======================
// WebChat Deluxe Full 2.0
// =======================

// ---- Firebase Imports ----
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, getDocs, onSnapshot, query, orderBy, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

// ---- Firebase Config ----
const firebaseConfig = {
  apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
  authDomain: "webchat-a47cc.firebaseapp.com",
  databaseURL: "https://webchat-a47cc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "webchat-a47cc",
  storageBucket: "webchat-a47cc.appspot.com",
  messagingSenderId: "318380716143",
  appId: "1:318380716143:web:da7474bfa392dfeaccdd9a",
  measurementId: "G-GBFBS5F8GB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ---- UI References ----
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatTitle = document.getElementById('chatTitle');
const callButtons = document.getElementById('callButtons');
const audioCallBtn = document.getElementById('audioCallBtn');
const videoCallBtn = document.getElementById('videoCallBtn');
const groupVideoBtn = document.getElementById('groupVideoBtn');
const endCallBtn = document.getElementById('endCallBtn');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImg');
const videoGrid = document.getElementById('videoGrid');
const incomingPopup = document.getElementById('incomingPopup');
const popupCaller = document.getElementById('popupCaller');
const acceptCallBtn = document.getElementById('acceptCallBtn');
const declineCallBtn = document.getElementById('declineCallBtn');

// ---- State ----
let me = null;
let selectedPeer = null;
let messagesUnsub = null;
let selectedFile = null;
let localStream = null;
let peerConnections = {};
let myOfferDocs = {};
let activeGroupCallId = null;

const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];
const GROUP_CALLS_COL = 'groupCalls';
const groupCallsCol = collection(db, GROUP_CALLS_COL);

// ========================
// Auth Functions
// ========================
window.signup = async () => {
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  if (!email || !pw) return alert('E-Mail + Passwort eingeben');
  try { await createUserWithEmailAndPassword(auth, email, pw); }
  catch(e) { alert(e.message); }
};

window.login = async () => {
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  if (!email || !pw) return alert('E-Mail + Passwort eingeben');
  try { await signInWithEmailAndPassword(auth, email, pw); }
  catch(e) { alert(e.message); }
};

window.logout = async () => {
  try { await signOut(auth); } catch(e) {}
  selectedPeer = null;
  chatBox.innerHTML = '';
  videoGrid.innerHTML = '';
  userArea.style.display = 'none';
  authArea.style.display = 'block';
  stopLocalStreams();
  Object.values(peerConnections).forEach(pc=>pc.close());
  peerConnections = {};
  myOfferDocs = {};
  activeGroupCallId = null;
};

// ========================
// Auth State Listener
// ========================
onAuthStateChanged(auth, async (user)=>{
  if(user){
    me = { uid:user.uid, email:user.email, name:(user.email||'').split('@')[0] };
    try{ await setDoc(doc(db,'users',me.uid),me,{merge:true}); } catch(e){ console.error(e);}
    authArea.style.display='none'; userArea.style.display='block';
    userInfo.textContent = `Angemeldet als ${me.name}`;
    loadContacts(); loadGroups();
    chatTitle.textContent = 'WÃ¤hle einen Chat';
    setupIncomingWatcher();
  } else {
    me = null;
    authArea.style.display='block'; userArea.style.display='none';
    chatTitle.textContent='Bitte anmelden';
    chatBox.innerHTML=''; videoGrid.innerHTML='';
  }
});

// ========================
// Load Contacts & Groups
// ========================
async function loadContacts(){
  contactsDiv.innerHTML='';
  const snap = await getDocs(collection(db,'users'));
  snap.forEach(d=>{
    const u = d.data();
    if(u.uid === me.uid) return;
    const div = document.createElement('div');
    div.className='contact-item';
    div.textContent = u.name;
    div.onclick = ()=>selectChat({type:'user',id:u.uid,name:u.name});
    contactsDiv.appendChild(div);
  });
}

async function loadGroups(){
  groupsDiv.innerHTML='';
  if(!me) return;
  const q = query(collection(db,'groups'), where('members','array-contains',me.uid));
  const snap = await getDocs(q);
  snap.forEach(d=>{
    const g = d.data();
    const div = document.createElement('div');
    div.className='group-item';
    div.textContent=g.name;
    div.onclick=()=>selectChat({type:'group',id:d.id,name:g.name});
    groupsDiv.appendChild(div);
  });
}

// ========================
// Chat Functions
// ========================
async function selectChat(peer){
  selectedPeer = peer;
  chatTitle.textContent=peer.name;
  chatBox.innerHTML='';
  callButtons.style.display = (peer.type==='user')?'flex':'none';
  if(messagesUnsub) messagesUnsub();

  let messagesQuery;
  if(peer.type==='user'){
    messagesQuery=query(collection(db,'messages'), orderBy('timestamp'));
  } else {
    messagesQuery=query(collection(db,'messages'), where('to','==',peer.id), orderBy('timestamp'));
  }

  messagesUnsub = onSnapshot(messagesQuery, snap=>{
    chatBox.innerHTML='';
    snap.forEach(docu=>{
      const m=docu.data();
      if(peer.type==='user'){
        if((m.from===me.uid && m.to===peer.id)||(m.from===peer.id && m.to===me.uid)) renderMessage(m);
      } else {
        if(m.to===peer.id) renderMessage(m);
      }
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

function renderMessage(m){
  if(!m) return;
  if(m.type==='image'){
    const img=document.createElement('img');
    img.src=m.url; img.className='preview-img message ' + (m.from===me.uid?'sent':'received');
    chatBox.appendChild(img);
  } else {
    const d=document.createElement('div');
    d.className='message ' + (m.from===me.uid?'sent':'received');
    d.textContent=(m.fromName?m.fromName+': ':'')+(m.text||'');
    chatBox.appendChild(d);
  }
}

// Send Message
window.sendMessage=async()=>{
  if(!selectedPeer) return alert('WÃ¤hle erst einen Chat');
  const text = messageInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,'messages'),{
    from: me.uid,
    fromName: me.name,
    to: selectedPeer.id,
    type:'text',
    text,
    timestamp: Date.now()
  });
  messageInput.value='';
};

// Send Image
imageInput.addEventListener('change',e=>{
  selectedFile=e.target.files[0];
  if(selectedFile){ previewImg.src=URL.createObjectURL(selectedFile); previewImg.style.display='block'; }
  else previewImg.style.display='none';
});
window.sendImage=async()=>{
  if(!selectedPeer) return alert('WÃ¤hle erst einen Chat');
  if(!selectedFile) return alert('Keine Datei ausgewÃ¤hlt');
  const clean = selectedFile.name.replace(/[^\w.-]/g,'_');
  const path = `chatImages/${me.uid}_${Date.now()}_${clean}`;
  const storageRef=ref(storage,path);
  const snap=await uploadBytes(storageRef,selectedFile);
  const url=await getDownloadURL(snap.ref);
  await addDoc(collection(db,'messages'),{
    from: me.uid,
    fromName: me.name,
    to: selectedPeer.id,
    type:'image',
    url,
    timestamp: Date.now()
  });
  selectedFile=null; imageInput.value=''; previewImg.style.display='none';
};

// Typing Indicator
let typingTimer=null;
messageInput.addEventListener('input', async ()=>{
  if(!selectedPeer) return;
  await addDoc(collection(db,'messages'),{from:me.uid,fromName:me.name,to:selectedPeer.id,typing:true,timestamp:Date.now()});
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>{},1000);
});

// ========================
// Groups
// ========================
window.createGroup = async ()=>{
  const name=document.getElementById('newGroupName').value.trim();
  if(!name) return alert('Gruppenname angeben');
  await addDoc(collection(db,'groups'),{name,members:[me.uid],created:Date.now()});
  loadGroups();
};

// ========================
// WebRTC Functions
// ========================

// --- create PeerConnection ---
function createPC(role, peerId, docRef=null){
  const pc = new RTCPeerConnection({iceServers: ICE_SERVERS});

  pc.onicecandidate = e=>{
    if(!e.candidate) return;
    const cand = e.candidate.toJSON();
    if(!docRef) return;
    const colName = (role==='caller')?'offerCandidates':'answerCandidates';
    addDoc(collection(docRef,colName), cand).catch(console.error);
  };

  pc.ontrack = e=>{
    const id='video_'+peerId;
    let v=document.getElementById(id);
    if(!v){
      v=document.createElement('video'); v.id=id; v.autoplay=true; v.playsInline=true; v.style.borderRadius='8px';
      videoGrid.appendChild(v);
    }
    try{ v.srcObject = e.streams[0]; } catch(err){ console.error(err);}
  };

  return pc;
}

// --- start group video call ---
async function startGroupVideoCall(){
  if(!selectedPeer||selectedPeer.type!=='group') return alert('WÃ¤hle eine Gruppe');
  const groupDocRef=doc(db,'groups',selectedPeer.id);
  const groupSnap=await getDoc(groupDocRef);
  if(!groupSnap.exists()) return alert('Gruppe nicht gefunden');
  const members=(groupSnap.data().members||[]).filter(uid=>uid!==me.uid);
  if(!members.length) return alert('Keine anderen Mitglieder');

  try{ localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true}); }
  catch(e){ alert('Kamera/Mikrofon nicht verfÃ¼gbar'); return;}

  let localV=document.getElementById('video_local');
  if(!localV){ localV=document.createElement('video'); localV.id='video_local'; localV.autoplay=true; localV.muted=true; localV.playsInline=true; videoGrid.appendChild(localV);}
  localV.srcObject = localStream;

  for(const peerId of members){
    const pc=createPC('caller',peerId);
    peerConnections[peerId]=pc;
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    const offerDesc=await pc.createOffer();
    await pc.setLocalDescription(offerDesc);
    const callDoc = await addDoc(groupCallsCol,{
      from: me.uid, to:peerId, group:selectedPeer.id, offer:offerDesc.toJSON(), active:true, createdAt:Date.now()
    });
    myOfferDocs[peerId]=callDoc;

    onSnapshot(callDoc, async snap=>{
      const data=snap.data();
      if(!data) return;
      if(data.answer && !pc.currentRemoteDescription) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      if(data.active===false){ try{pc.close();}catch(e){} delete peerConnections[peerId]; const v=document.getElementById('video_'+peerId); if(v)v.remove();}
    });

    const answerCandidatesCol=collection(callDoc,'answerCandidates');
    onSnapshot(answerCandidatesCol,snapc=>{
      snapc.docChanges().forEach(ch=>{
        if(ch.type==='added') pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(console.error);
      });
    });
  }

  activeGroupCallId = selectedPeer.id;
  endCallBtn.style.display='inline-block';
}

groupVideoBtn.onclick=startGroupVideoCall;

function stopLocalStreams(){
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; const lv=document.getElementById('video_local'); if(lv) lv.remove();}
}

async function endAllGroupCalls(){
  for(const pid in myOfferDocs){ try{ await updateDoc(myOfferDocs[pid],{active:false});} catch(e){} }
  Object.values(peerConnections).forEach(pc=>pc.close());
  peerConnections={}; myOfferDocs={}; activeGroupCallId=null;
  stopLocalStreams();
  endCallBtn.style.display='none';
  videoGrid.innerHTML='';
}

endCallBtn.onclick=endAllGroupCalls;

// --- Incoming calls ---
function setupIncomingWatcher(){
  const q=query(groupCallsCol, where('to','==',me?me.uid:''));
  onSnapshot(q,snap=>{
    snap.docChanges().forEach(async change=>{
      if(change.type!=='added') return;
      const data=change.doc.data();
      const docRef=change.doc.ref;
      if(!data||!data.active||!data.group) return;
      popupCaller.textContent=`Gruppe: ${data.group} â€” von: ${data.from}`;
      incomingPopup.style.display='block';

      acceptCallBtn.onclick=async()=>{
        incomingPopup.style.display='none';
        try{ localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true}); }
        catch(e){ alert('Kamera/Mikrofon nicht verfÃ¼gbar'); return;}
        const callerId = data.from;
        const pc=createPC('answerer',callerId,docRef);
        peerConnections[callerId]=pc;
        localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
        let v=document.getElementById('video_local');
        if(!v){ v=document.createElement('video'); v.id='video_local'; v.autoplay=true; v.muted=true; v.playsInline=true; v.srcObject=localStream; videoGrid.appendChild(v);}
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer=await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await updateDoc(docRef,{answer:answer.toJSON(),active:true});
        const offerCandidatesCol=collection(docRef,'offerCandidates');
        onSnapshot(offerCandidatesCol,snapc=>{ snapc.docChanges().forEach(ch=>{ if(ch.type==='added') pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(console.error); });});
      };

      declineCallBtn.onclick=async()=>{
        incomingPopup.style.display='none';
        await updateDoc(docRef,{active:false}).catch(console.error);
      };
    });
  });
}

</script>

</body>
</html>

