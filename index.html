<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebChat Deluxe V1.2.2</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>WebChat Deluxe V1.2.2</h2>
    <div id="authArea">
      <input type="email" id="email" placeholder="E-Mail"><br><br>
      <input type="password" id="password" placeholder="Passwort"><br><br>
      <button type="button" onclick="signup()">Registrieren</button>
      <button type="button" style="margin-top:8px;background:#059669" onclick="login()">Anmelden</button>
    </div>

    <div id="userArea" style="display:none;">
      <div id="userInfo"></div>
      <button type="button" style="background:#dc2626;margin-top:8px" onclick="logout()">Abmelden</button>
      <hr/>
      <h4>Kontakte</h4>
      <div id="contacts"></div>
      <input id="addContactInput" placeholder="Name hinzuf√ºgen"><br>
      <button type="button" style="margin-top:6px" onclick="addContactByName()">Hinzuf√ºgen</button>
      <hr/>
      <h4>Gruppen</h4>
      <div id="groups"></div>
      <input id="newGroupName" placeholder="Gruppenname"><br>
      <button type="button" style="margin-top:6px" onclick="createGroup()">Erstellen</button>
    </div>
  </div>

  <div class="main">
    <div id="chatHeader" class="chat-header">
      <h3 id="chatTitle">Bitte anmelden</h3>
      <div class="call-buttons" id="callButtons" style="display:none;">
        <button id="audioCallBtn" title="Sprachanruf starten">üìû</button>
        <button id="videoCallBtn" title="Videoanruf starten">üé•</button>
        <button id="endCallBtn" title="Auflegen" style="display:none;">‚ùå</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box"></div>

    <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px;">
      <div style="display:flex;gap:8px;">
        <input id="messageInput" placeholder="Nachricht..." style="flex:1">
        <input type="file" id="imageInput" accept="image/*">
        <button type="button" onclick="sendMessage()">Senden</button>
        <button type="button" id="sendImageBtn">Bild senden</button>
      </div>
      <img id="previewImg" style="display:none;">
    </div>

    <div id="videoContainer" style="display:none;flex-direction:column;align-items:center;margin-top:10px;">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline style="margin-top:10px;"></video>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
  authDomain: "webchat-a47cc.firebaseapp.com",
  databaseURL: "https://webchat-a47cc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "webchat-a47cc",
  storageBucket: "webchat-a47cc.firebasestorage.app",
  messagingSenderId: "318380716143",
  appId: "1:318380716143:web:da7474bfa392dfeaccdd9a",
  measurementId: "G-GBFBS5F8GB"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- UI Elemente ---
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatTitle = document.getElementById('chatTitle');
const callButtons = document.getElementById('callButtons');
const audioCallBtn = document.getElementById('audioCallBtn');
const videoCallBtn = document.getElementById('videoCallBtn');
const endCallBtn = document.getElementById('endCallBtn');
const videoContainer = document.getElementById('videoContainer');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const sendImageBtn = document.getElementById('sendImageBtn');
const previewImg = document.getElementById('previewImg');

// --- Variablen ---
let me = null;
let selectedPeer = null;
let unreadCounts = {};
let pc = null;
let localStream = null;
let callDoc = null;

// --- Klingelton ---
const ringtone = new Audio('https://www.soundjay.com/phone/phone-ring-01a.mp3');
ringtone.loop = true;

// --- Notifications + Sound ---
let notifyAllowed = false;
const messageSound = new Audio('https://www.soundjay.com/button/beep-07.mp3');
async function requestNotificationPermission(){
  if(!("Notification" in window)) return false;
  if(Notification.permission==="granted") return true;
  const permission = await Notification.requestPermission();
  return permission==="granted";
}
requestNotificationPermission().then(granted=>notifyAllowed=granted);
function showNotification(title, body){
  if(!notifyAllowed) return;
  new Notification(title,{body});
  messageSound.play().catch(()=>{});
}

// --- Auth State ---
onAuthStateChanged(auth, async user=>{
  if(user){
    me = { uid:user.uid, email:user.email, name:user.email.split('@')[0] };
    await setDoc(doc(db,'users',me.uid), me, {merge:true});
    authArea.style.display='none';
    userArea.style.display='block';
    userInfo.textContent=`Angemeldet als ${me.name}`;
    loadContacts();
    loadGroups();
    chatTitle.textContent='W√§hle einen Chat';
  } else {
    me=null;
    authArea.style.display='block';
    userArea.style.display='none';
    chatTitle.textContent='Bitte anmelden';
    chatBox.innerHTML='';
  }
});

// --- Auth Funktionen ---
async function signup(){
  const email=document.getElementById('email').value;
  const pw=document.getElementById('password').value;
  if(!email||!pw){alert("E-Mail + Passwort angeben");return;}
  try{ await createUserWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
}

async function login(){
  const email=document.getElementById('email').value;
  const pw=document.getElementById('password').value;
  if(!email||!pw){alert("E-Mail + Passwort angeben");return;}
  try{ await signInWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
}

async function logout(){
  await signOut(auth);
  selectedPeer=null;
  chatBox.innerHTML='';
}

// --- Kontakte laden ---
async function loadContacts(){
  contactsDiv.innerHTML='';
  const q=query(collection(db,'users'));
  const snap=await getDocs(q);
  snap.forEach(docu=>{
    const u=docu.data();
    if(u.uid!==me.uid){
      const div=document.createElement('div');
      const nameSpan = document.createElement('span');
      nameSpan.textContent = u.name;
      const countSpan = document.createElement('span');
      countSpan.style.color = 'red';
      countSpan.id = `unread-${u.uid}`;
      countSpan.textContent = unreadCounts[u.uid] || '';
      div.appendChild(nameSpan);
      div.appendChild(countSpan);
      div.onclick = () => {
        selectedPeer={type:'user',id:u.uid,name:u.name};
        unreadCounts[u.uid]=0;
        updateUnreadBadge(u.uid);
        loadChat();
        callButtons.style.display='inline-flex';
      };
      contactsDiv.appendChild(div);
    }
  });
}

// --- Gruppen laden ---
async function loadGroups(){
  groupsDiv.innerHTML='';
  const q=query(collection(db,'groups'), where('members','array-contains',me.uid));
  const snap=await getDocs(q);
  snap.forEach(docu=>{
    const g=docu.data();
    const div=document.createElement('div');
    const nameSpan = document.createElement('span');
    nameSpan.textContent = g.name;
    const countSpan = document.createElement('span');
    countSpan.style.color='red';
    countSpan.id = `unread-${docu.id}`;
    countSpan.textContent = unreadCounts[docu.id] || '';
    div.appendChild(nameSpan);
    div.appendChild(countSpan);
    div.onclick = () => {
      selectedPeer={type:'group',id:docu.id,name:g.name};
      unreadCounts[docu.id]=0;
      updateUnreadBadge(docu.id);
      loadChat();
      callButtons.style.display='inline-flex';
    };
    groupsDiv.appendChild(div);
  });
}

// --- Update Badge ---
function updateUnreadBadge(chatId){
  const span = document.getElementById(`unread-${chatId}`);
  if(span) span.textContent = unreadCounts[chatId] || '';
}

// --- Kontakt hinzuf√ºgen ---
async function addContactByName(){
  const name=document.getElementById('addContactInput').value.trim();
  if(!name){alert('Name angeben'); return;}
  const q=query(collection(db,'users'),where('name','==',name));
  const snap=await getDocs(q);
  if(snap.empty){alert('Nutzer nicht gefunden'); return;}
  alert('Kontakt kann jetzt f√ºr private Gruppen genutzt werden.');
}

// --- Gruppe erstellen ---
async function createGroup(){
  const name=document.getElementById('newGroupName').value.trim();
  if(!name) return alert('Gruppenname angeben');
  const emails = prompt("E-Mail-Adressen der Mitglieder (komma-getrennt)").split(',').map(s=>s.trim());
  const membersUIDs = [];
  for(const email of emails){
    const q = query(collection(db,'users'), where('email','==',email));
    const snap = await getDocs(q);
    if(!snap.empty) membersUIDs.push(snap.docs[0].id);
  }
  membersUIDs.push(me.uid);
  await addDoc(collection(db,'groups'), {name, members: membersUIDs});
  loadGroups();
  alert('Private Gruppe erstellt!');
}

// --- Chat laden, Nachrichten rendern, Text/Bild senden ---
// Hier kannst du deinen bestehenden V1.2.1 Chatcode einf√ºgen (wie oben), ich kann ihn bei Bedarf komplett erg√§nzen

// --- WebRTC Call-Funktionen ---
async function startCall(video=false){
  if(!selectedPeer) return alert("W√§hle zuerst einen Chat aus!");
  ringtone.play().catch(()=>{});

  videoContainer.style.display=video?"flex":"none";
  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:video});
  localVideo.srcObject=localStream;

  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack=e=>{remoteVideo.srcObject=e.streams[0];};

  const callRef=doc(collection(db,"calls"));
  callDoc=callRef;
  const offerCandidates=collection(callRef,"offerCandidates");
  const answerCandidates=collection(callRef,"answerCandidates");

  pc.onicecandidate=e=>{if(e.candidate) addDoc(offerCandidates,e.candidate.toJSON());};

  const offerDesc=await pc.createOffer();
  await pc.setLocalDescription(offerDesc);
  const offer={sdp:offerDesc.sdp,type:offerDesc.type};
  await setDoc(callRef,{offer,from:me.uid,to:selectedPeer.id,active:true,video});

  onSnapshot(callRef,async snap=>{
    const data=snap.data();
    if(data?.answer){
      ringtone.pause();
      ringtone.currentTime=0;
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });

  onSnapshot(answerCandidates,snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added") pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
    });
  });

  audioCallBtn.style.display="none";
  videoCallBtn.style.display="none";
  endCallBtn.style.display="inline-block";
}

async function endCall(){
  if(pc) pc.close();
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  pc=null; localStream=null;
  videoContainer.style.display="none";
  audioCallBtn.style.display="inline-block";
  videoCallBtn.style.display="inline-block";
  endCallBtn.style.display="none";
  ringtone.pause();
  ringtone.currentTime=0;
}

audioCallBtn.onclick=()=>startCall(false);
videoCallBtn.onclick=()=>startCall(true);
endCallBtn.onclick=()=>endCall();

// --- Eingehende Anrufe ---
onSnapshot(collection(db,"calls"),snapshot=>{
  snapshot.docChanges().forEach(async change=>{
    const data=change.doc.data();
    if(change.type==="added" && data.to===me?.uid && !pc){
      ringtone.play().catch(()=>{});
      const accept=confirm(`${data.video?"Video":"Audio"}-Anruf von ${data.from}. Annehmen?`);
      ringtone.pause(); ringtone.currentTime=0;
      if(!accept) return;
      pc=new RTCPeerConnection();
      localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:data.video});
      localVideo.srcObject=localStream;
      videoContainer.style.display=data.video?"flex":"none";
      localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
      pc.ontrack=e=>{remoteVideo.srcObject=e.streams[0];};
      const answerCandidates=collection(change.doc.ref,"answerCandidates");
      pc.onicecandidate=e=>{if(e.candidate) addDoc(answerCandidates,e.candidate.toJSON());};
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answerDesc=await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);
      const answer={type:answerDesc.type,sdp:answerDesc.sdp};
      await updateDoc(change.doc.ref,{answer});
    }
  });
});

</script>
</body>
</html>



