<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WebChat Deluxe V1.2.9</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>WebChat Deluxe V1.2.9</h2>
    <div id="authArea">
      <input type="email" id="email" placeholder="E-Mail"><br><br>
      <input type="password" id="password" placeholder="Passwort"><br><br>
      <button type="button" onclick="signup()">Registrieren</button>
      <button type="button" style="margin-top:8px;background:#059669" onclick="login()">Anmelden</button>
    </div>

    <div id="userArea" style="display:none;">
      <div id="userInfo"></div>
      <button type="button" style="background:#dc2626;margin-top:8px" onclick="logout()">Abmelden</button>
      <hr/>
      <h4>Kontakte</h4>
      <div id="contacts"></div>
      <input id="addContactInput" placeholder="Name hinzufügen"><br>
      <button type="button" style="margin-top:6px" onclick="addContactByName()">Hinzufügen</button>
      <hr/>
      <h4>Gruppen</h4>
      <div id="groups"></div>
      <input id="newGroupName" placeholder="Gruppenname"><br>
      <button type="button" style="margin-top:6px" onclick="createGroup()">Erstellen</button>
    </div>
  </div>

  <div class="main">
    <div id="chatHeader" class="chat-header">
      <h3 id="chatTitle">Bitte anmelden</h3>
      <div class="call-buttons" id="callButtons" style="display:none;">
        <button id="audioCallBtn" title="Sprachanruf starten">📞</button>
        <button id="videoCallBtn" title="Videoanruf starten">🎥</button>
        <button id="endCallBtn" title="Auflegen" style="display:none;">❌</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box"></div>

    <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px;">
      <div style="display:flex;gap:8px;">
        <input id="messageInput" placeholder="Nachricht..." style="flex:1">
        <input type="file" id="imageInput" accept="image/*">
        <button type="button" onclick="sendMessage()">Senden</button>
        <button type="button" id="sendImageBtn">Bild senden</button>
      </div>
      <img id="previewImg" style="display:none;max-width:200px;border-radius:8px;">
    </div>

    <div id="videoContainer" style="display:none;flex-direction:column;align-items:center;margin-top:10px;">
      <video id="localVideo" autoplay muted playsinline style="width:40%;border-radius:10px;"></video>
      <video id="remoteVideo" autoplay playsinline style="width:40%;border-radius:10px;margin-top:10px;"></video>
    </div>

    <audio id="remoteAudio" autoplay playsinline></audio>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, onSnapshot, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
  authDomain: "webchat-a47cc.firebaseapp.com",
  projectId: "webchat-a47cc",
  storageBucket: "webchat-a47cc.appspot.com",
  messagingSenderId: "318380716143",
  appId: "1:318380716143:web:da7474bfa392dfeaccdd9a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- UI Elemente ---
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatTitle = document.getElementById('chatTitle');
const callButtons = document.getElementById('callButtons');
const audioCallBtn = document.getElementById('audioCallBtn');
const videoCallBtn = document.getElementById('videoCallBtn');
const endCallBtn = document.getElementById('endCallBtn');
const videoContainer = document.getElementById('videoContainer');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const remoteAudio = document.getElementById('remoteAudio');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const sendImageBtn = document.getElementById('sendImageBtn');
const previewImg = document.getElementById('previewImg');

// --- Sounds ---
const messageSound = new Audio('https://www.soundjay.com/button/beep-07.mp3');
const callSound = new Audio('https://www.soundjay.com/button/sounds/button-16.mp3'); // einfacher Klingelton

// --- State ---
let me = null;
let selectedPeer = null;
let unreadCounts = {};
let pc = null;
let localStream = null;
let callDoc = null;

// --- Auth State ---
onAuthStateChanged(auth, async user => {
  if(user){
    me = { uid: user.uid, email: user.email, name: user.email.split('@')[0] };
    await setDoc(doc(db,'users',me.uid), me, {merge:true});
    authArea.style.display='none';
    userArea.style.display='block';
    userInfo.textContent=`Angemeldet als ${me.name}`;
    loadContacts();
    loadGroups();
    chatTitle.textContent='Wähle einen Chat';
  } else {
    me=null;
    authArea.style.display='block';
    userArea.style.display='none';
    chatTitle.textContent='Bitte anmelden';
    chatBox.innerHTML='';
  }
});

// --- Auth Funktionen ---
window.signup=async()=>{
  const email=document.getElementById('email').value;
  const pw=document.getElementById('password').value;
  if(!email||!pw){alert("E-Mail + Passwort angeben"); return;}
  try{ await createUserWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
};
window.login=async()=>{
  const email=document.getElementById('email').value;
  const pw=document.getElementById('password').value;
  if(!email||!pw){alert("E-Mail + Passwort angeben"); return;}
  try{ await signInWithEmailAndPassword(auth,email,pw);}catch(e){alert(e.message);}
};
window.logout=async()=>{ await signOut(auth); selectedPeer=null; chatBox.innerHTML=''; };

// --- Kontakte & Gruppen ---
async function loadContacts(){
  contactsDiv.innerHTML='';
  const q=query(collection(db,'users'));
  const snap=await getDocs(q);
  snap.forEach(docu=>{
    const u=docu.data();
    if(u.uid!==me.uid){
      const div=document.createElement('div');
      const nameSpan=document.createElement('span');
      nameSpan.textContent=u.name;
      const countSpan=document.createElement('span');
      countSpan.id=`unread-${u.uid}`;
      countSpan.textContent=unreadCounts[u.uid]||'';
      div.appendChild(nameSpan);
      div.appendChild(countSpan);
      div.onclick=()=>{
        selectedPeer={type:'user',id:u.uid,name:u.name};
        unreadCounts[u.uid]=0;
        updateUnreadBadge(u.uid);
        loadChat();
      };
      contactsDiv.appendChild(div);
    }
  });
}

async function loadGroups(){
  groupsDiv.innerHTML='';
  const q=query(collection(db,'groups'),where('members','array-contains',me.uid));
  const snap=await getDocs(q);
  snap.forEach(docu=>{
    const g=docu.data();
    const div=document.createElement('div');
    const nameSpan=document.createElement('span');
    nameSpan.textContent=g.name;
    const countSpan=document.createElement('span');
    countSpan.id=`unread-${docu.id}`;
    countSpan.textContent=unreadCounts[docu.id]||'';
    div.appendChild(nameSpan);
    div.appendChild(countSpan);
    div.onclick=()=>{
      selectedPeer={type:'group',id:docu.id,name:g.name};
      unreadCounts[docu.id]=0;
      updateUnreadBadge(docu.id);
      loadChat();
    };
    groupsDiv.appendChild(div);
  });
}

window.addContactByName = async () => {
  const name = document.getElementById('addContactInput').value.trim();
  if(!name) return alert('Name eingeben');
  try{
    const newDoc = doc(collection(db,'users'));
    await setDoc(doc(db,'users',newDoc.id), { uid: newDoc.id, name, email: `${name}@example.local` });
    document.getElementById('addContactInput').value='';
    loadContacts();
  }catch(e){ console.error(e); alert('Fehler beim Hinzufügen'); }
};

window.createGroup = async () => {
  const gname = document.getElementById('newGroupName').value.trim();
  if(!gname) return alert('Gruppenname angeben');
  try{
    await addDoc(collection(db,'groups'), { name: gname, members: [me.uid], createdAt: Date.now() });
    document.getElementById('newGroupName').value='';
    loadGroups();
  }catch(e){ console.error(e); alert('Fehler beim Erstellen'); }
};

// --- Chat laden & Nachrichten ---
async function loadChat(){
  if(!selectedPeer){ chatTitle.textContent='Wähle einen Chat'; callButtons.style.display='none'; return; }
  chatTitle.textContent=selectedPeer.name;
  callButtons.style.display=selectedPeer.type==='user'?'flex':'none';
  chatBox.innerHTML='';

  let messagesQuery;
  if(selectedPeer.type==='user'){
    messagesQuery=query(collection(db,'messages'),orderBy('timestamp'));
  } else {
    messagesQuery=query(collection(db,'messages'),where('to','==',selectedPeer.id),orderBy('timestamp'));
  }

  onSnapshot(messagesQuery,snap=>{
    chatBox.innerHTML='';
    snap.forEach(docu=>{
      const m=docu.data();
      if(selectedPeer.type==='user'){
        if((m.from===me.uid && m.to===selectedPeer.id)||(m.from===selectedPeer.id && m.to===me.uid)){
          renderMessage(m);
          if(m.from!==me.uid) messageSound.play().catch(()=>{});
        } else if(m.from!==me.uid && m.to===me.uid){
          unreadCounts[m.from]=(unreadCounts[m.from]||0)+1;
          updateUnreadBadge(m.from);
        }
      } else {
        if(m.to===selectedPeer.id){
          renderMessage(m);
          if(m.from!==me.uid) messageSound.play().catch(()=>{});
        }
      }
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

function renderMessage(m){
  if(m.type==='image'){
    const img=document.createElement('img');
    img.src=m.url;
    img.className='chat-img message '+(m.from===me.uid?'sent':'received');
    img.style.maxWidth='200px';
    img.style.borderRadius='8px';
    img.style.margin='5px';
    chatBox.appendChild(img);
  } else {
    const div=document.createElement('div');
    div.textContent=m.text;
    div.className='message '+(m.from===me.uid?'sent':'received');
    chatBox.appendChild(div);
  }
}

window.sendMessage=async()=>{
  if(!selectedPeer){alert('Chat auswählen'); return;}
  const text=messageInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,'messages'),{from:me.uid,to:selectedPeer.id,type:'text',text,timestamp:Date.now()});
  messageInput.value='';
};

imageInput.addEventListener('change',()=>{
  const file=imageInput.files[0];
  if(file){
    previewImg.src=URL.createObjectURL(file);
    previewImg.style.display='block';
  } else previewImg.style.display='none';
});

window.sendImage=async()=>{
  if(!selectedPeer){alert('Chat auswählen'); return;}
  const file=imageInput.files[0];
  if(!file){alert('Keine Datei gewählt'); return;}

  try {
    const cleanName=file.name.replace(/[^\w.-]/g,"_");
    const path = `chatImages/${me.uid}_${Date.now()}_${cleanName}`;
    const storageRef = ref(storage, path);
    const snapshot = await uploadBytes(storageRef, file);
    const url = await getDownloadURL(snapshot.ref);

    await addDoc(collection(db,'messages'),{
      from: me.uid,
      to: selectedPeer.id,
      type: 'image',
      url,
      timestamp: Date.now()
    });

    imageInput.value='';
    previewImg.style.display='none';
  } catch (err) {
    console.error("Upload-Fehler:", err);
    alert("Fehler beim Hochladen des Bildes.");
  }
};
sendImageBtn.addEventListener('click',sendImage);

function updateUnreadBadge(chatId){
  const span=document.getElementById(`unread-${chatId}`);
  if(span) span.textContent=unreadCounts[chatId]||'';
}

// --- Incoming Calls mit einfachem Klingelton ---
onSnapshot(collection(db,"calls"),snapshot=>{
  snapshot.docChanges().forEach(async change=>{
    const data = change.doc.data();
    const docRef = change.doc.ref;
    if(change.type==="added" && data.to===me?.uid && !pc && data.active){
      callSound.play().catch(()=>{});

      const accept = confirm(`${data.video ? "Video" : "Audio"}-Anruf von ${data.from}. Annehmen?`);
      callSound.pause();
      callSound.currentTime=0;

      if(!accept){ await updateDoc(docRef,{active:false}); return; }

      pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      try { localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:data.video}); localVideo.srcObject=localStream; } 
      catch(err){ console.error(err); alert("Kamera/Mikrofon Fehler"); return; }
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; remoteAudio.srcObject = e.streams[0]; };
      videoContainer.style.display = data.video ? "flex" : "none";

      const answerCandidates = collection(docRef,"answerCandidates");
      pc.onicecandidate = e => { if(e.candidate) addDoc(answerCandidates,e.candidate.toJSON()); };

      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answerDesc = await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);
      await updateDoc(docRef,{answer:{type:answerDesc.type,sdp:answerDesc.sdp},active:true});

      callDoc = docRef;
      audioCallBtn.style.display="none";
      videoCallBtn.style.display="none";
      endCallBtn.style.display="inline-block";
    }
  });
});
</script>

</body>
</html>



