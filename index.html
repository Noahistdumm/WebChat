<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebChat Deluxe V1.2.0 ‚Äì mit Anruffunktion</title>
<link rel="stylesheet" href="styles.css">
<style>
  video {
    width: 200px;
    border-radius: 8px;
    margin: 4px;
  }
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>WebChat Deluxe V1.2.0</h2>
    <div id="authArea">
      <input type="email" id="email" placeholder="E-Mail"><br><br>
      <input type="password" id="password" placeholder="Passwort"><br><br>
      <button type="button" onclick="signup()">Registrieren</button>
      <button type="button" style="margin-top:8px;background:#059669" onclick="login()">Anmelden</button>
    </div>

    <div id="userArea" style="display:none;">
      <div id="userInfo"></div>
      <button type="button" style="background:#dc2626;margin-top:8px" onclick="logout()">Abmelden</button>
      <hr/>
      <h4>Kontakte</h4>
      <div id="contacts"></div>
      <input id="addContactInput" placeholder="Name hinzuf√ºgen"><br>
      <button type="button" style="margin-top:6px" onclick="addContactByName()">Hinzuf√ºgen</button>
      <hr/>
      <h4>Gruppen</h4>
      <div id="groups"></div>
      <input id="newGroupName" placeholder="Gruppenname"><br>
      <button type="button" style="margin-top:6px" onclick="createGroup()">Erstellen</button>
    </div>
  </div>

  <div class="main">
    <div id="chatHeader">
      <h3>Bitte anmelden</h3>
      <button id="callBtn" style="display:none;">üìû Anrufen</button>
      <button id="endCallBtn" style="display:none;background:#dc2626;">‚ùå Auflegen</button>
    </div>

    <div id="chatBox" class="chat-box"></div>

    <div style="display:flex;flex-direction:column;gap:4px;margin-top:8px;">
      <div style="display:flex;gap:8px;">
        <input id="messageInput" placeholder="Nachricht..." style="flex:1">
        <input type="file" id="imageInput" accept="image/*">
        <button type="button" onclick="sendMessage()">Senden</button>
        <button type="button" id="sendImageBtn">Bild senden</button>
      </div>
      <img id="previewImg" style="display:none;">
    </div>

    <div id="videoArea" style="display:flex;gap:8px;margin-top:10px;">
      <video id="localVideo" autoplay muted style="display:none;"></video>
      <video id="remoteVideo" autoplay style="display:none;"></video>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, query, where, getDocs, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
  authDomain: "webchat-a47cc.firebaseapp.com",
  projectId: "webchat-a47cc",
  storageBucket: "webchat-a47cc.firebasestorage.app",
  messagingSenderId: "318380716143",
  appId: "1:318380716143:web:da7474bfa392dfeaccdd9a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatHeader = document.getElementById('chatHeader');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const sendImageBtn = document.getElementById('sendImageBtn');
const previewImg = document.getElementById('previewImg');
const callBtn = document.getElementById('callBtn');
const endCallBtn = document.getElementById('endCallBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

let me = null;
let selectedPeer = null;
let peerConnection = null;
let localStream = null;

// --- AUTH & CHAT (gleich wie bisher, ausgelassen f√ºr K√ºrze) ---
// [Dein kompletter bisheriger Code bleibt gleich bis sendImageBtn.addEventListener('click', sendImage);]

// === AB HIER NEU: WEBRTC ===

const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function showCallButtons() {
  if (selectedPeer && selectedPeer.type === 'user') {
    callBtn.style.display = 'inline-block';
  } else {
    callBtn.style.display = 'none';
  }
}

async function setupLocalStream() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;
  localVideo.style.display = 'block';
}

callBtn.onclick = async () => {
  await setupLocalStream();
  peerConnection = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  const remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;
  remoteVideo.style.display = 'block';

  peerConnection.ontrack = event => event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  const callDoc = doc(collection(db, 'calls'));
  await setDoc(callDoc, { from: me.uid, to: selectedPeer.id, offer });

  const callerCandidates = collection(callDoc, 'callerCandidates');
  peerConnection.onicecandidate = e => e.candidate && addDoc(callerCandidates, e.candidate);

  onSnapshot(callDoc, async snap => {
    const data = snap.data();
    if (data?.answer && !peerConnection.currentRemoteDescription) {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });

  onSnapshot(collection(callDoc, 'calleeCandidates'), snap => {
    snap.docChanges().forEach(change => {
      if (change.type === 'added') {
        const candidate = new RTCIceCandidate(change.doc.data());
        peerConnection.addIceCandidate(candidate);
      }
    });
  });

  alert('Anruf gesendet!');
  callBtn.style.display = 'none';
  endCallBtn.style.display = 'inline-block';
};

onSnapshot(collection(db, 'calls'), async snapshot => {
  snapshot.docChanges().forEach(async change => {
    const call = change.doc.data();
    const callId = change.doc.id;

    if (call.to === me?.uid && call.offer && !call.answer) {
      const accept = confirm(`üìû ${call.from} ruft dich an. Annehmen?`);
      if (!accept) return;

      await setupLocalStream();
      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      const remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;
      remoteVideo.style.display = 'block';
      peerConnection.ontrack = event => event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));

      await peerConnection.setRemoteDescription(new RTCSessionDescription(call.offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      await setDoc(doc(db, 'calls', callId), { ...call, answer });

      const calleeCandidates = collection(db, 'calls', callId, 'calleeCandidates');
      peerConnection.onicecandidate = e => e.candidate && addDoc(calleeCandidates, e.candidate);
      endCallBtn.style.display = 'inline-block';
    }
  });
});

endCallBtn.onclick = () => {
  if (peerConnection) peerConnection.close();
  localVideo.style.display = 'none';
  remoteVideo.style.display = 'none';
  endCallBtn.style.display = 'none';
  callBtn.style.display = 'inline-block';
};
</script>
</body>
</html>
