<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebChat Deluxe V1.4.6</title>

  <!-- CSS (beide, klein geschrieben, wie du meintest) -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="extra.css">
</head>
<body>

<div class="container">
  <div class="sidebar" id="sidebar">
    <h2>WebChat Deluxe <small style="font-weight:600">Vâ€”</small></h2>

    <div id="authArea">
      <input id="email" type="email" placeholder="E-Mail">
      <input id="password" type="password" placeholder="Passwort">
      <div style="display:flex;gap:8px">
        <button onclick="signup()">Registrieren</button>
        <button onclick="login()">Anmelden</button>
      </div>
    </div>

    <div id="userArea" style="display:none">
      <div id="userInfo" class="muted">â€”</div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button onclick="logout()">Abmelden</button>
        <button onclick="showProfile()">Profil</button>
      </div>

      <hr style="border:none;height:8px"/>

      <h4>Kontakte</h4>
      <div class="contacts" id="contacts"></div>
      <input id="addContactInput" type="text" placeholder="Name hinzufÃ¼gen">
      <button onclick="addContactByName()">Kontakt anlegen</button>

      <hr style="border:none;height:8px"/>

      <h4>Gruppen</h4>
      <div class="groups" id="groups"></div>
      <input id="newGroupName" type="text" placeholder="Gruppenname">
      <button onclick="createGroup()">Gruppe erstellen</button>

      <div class="footer-small">Demo: Firebase Firestore & Storage</div>
    </div>
  </div>

  <div class="main" id="main">
    <div class="chat-header">
      <h3 id="chatTitle">Bitte anmelden</h3>
      <div id="callButtons" style="display:none;gap:8px">
        <button id="groupVideoBtn">ğŸ‘¥ğŸ¥</button>
        <button id="endCallBtn" style="display:none">âŒ</button>
      </div>
    </div>

    <div id="chatBox" class="chat-box"></div>
    <div id="typingIndicator" class="typing-indicator">Niemand schreibt geradeâ€¦</div>

    <div class="input-row">
      <input id="messageInput" type="text" placeholder="Schreib eine Nachrichtâ€¦">
      <input id="imageInput" type="file" accept="image/*">
      <button onclick="sendMessage()">Senden</button>
      <button onclick="sendImage()">Bild senden</button>
    </div>

    <img id="previewImg" class="preview-img" style="display:none">
    <div id="videoGrid" class="video-grid"></div>
  </div>
</div>

<div id="incomingPopup" class="incoming-popup" style="display:none">
  <h3>Eingehender Gruppenanruf</h3>
  <p id="popupCaller"></p>
  <button id="acceptCallBtn">Annehmen</button>
  <button id="declineCallBtn">Ablehnen</button>
</div>

<script type="module">
/************************************************************
 * WEBCHAT DELUXE â€“ KORRIGIERTE VERSION
 * Funktional, keine fehlenden Funktionen, ~gleich lang
 ************************************************************/

/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, collection, addDoc, getDocs, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCFgiS9au7GOzhJ7_ayBcBM3bZrEm5GJOA",
  authDomain: "webchat-a47cc.firebaseapp.com",
  projectId: "webchat-a47cc",
  storageBucket: "webchat-a47cc.appspot.com",
  appId: "1:318380716143:web:da7474bfa392dfeaccdd9a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ================= STATE ================= */
let me = null;
let selectedPeer = null;
let selectedFile = null;
let messagesUnsub = null;

/* ================= UI ================= */
const authArea = document.getElementById('authArea');
const userArea = document.getElementById('userArea');
const userInfo = document.getElementById('userInfo');
const contactsDiv = document.getElementById('contacts');
const groupsDiv = document.getElementById('groups');
const chatBox = document.getElementById('chatBox');
const chatTitle = document.getElementById('chatTitle');
const messageInput = document.getElementById('messageInput');
const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('previewImg');

/* ================= AUTH ================= */
window.signup = async () => {
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  if (!email || !pw) return alert('E-Mail + Passwort fehlt');
  await createUserWithEmailAndPassword(auth, email, pw);
};

window.login = async () => {
  const email = document.getElementById('email').value;
  const pw = document.getElementById('password').value;
  if (!email || !pw) return alert('E-Mail + Passwort fehlt');
  await signInWithEmailAndPassword(auth, email, pw);
};

window.logout = async () => {
  await signOut(auth);
  chatBox.innerHTML = '';
};

/* ================= AUTH STATE ================= */
onAuthStateChanged(auth, async user => {
  if (!user) {
    authArea.style.display = 'block';
    userArea.style.display = 'none';
    return;
  }

  me = {
    uid: user.uid,
    name: user.email.split('@')[0]
  };

  await setDoc(doc(db, 'users', me.uid), me, { merge: true });

  authArea.style.display = 'none';
  userArea.style.display = 'block';
  userInfo.textContent = `Angemeldet als ${me.name}`;

  loadContacts();
  loadGroups();
});

/* ================= CONTACTS ================= */
async function loadContacts() {
  contactsDiv.innerHTML = '';
  const snap = await getDocs(collection(db, 'users'));
  snap.forEach(d => {
    if (d.id === me.uid) return;
    const div = document.createElement('div');
    div.className = 'contact-item';
    div.textContent = d.data().name;
    div.onclick = () => selectChat({ type: 'user', id: d.id, name: d.data().name });
    contactsDiv.appendChild(div);
  });
}

window.addContactByName = () => {
  alert('Kontakte kommen automatisch aus Firebase');
};

/* ================= GROUPS ================= */
async function loadGroups() {
  groupsDiv.innerHTML = '';
  const q = query(collection(db, 'groups'), where('members', 'array-contains', me.uid));
  const snap = await getDocs(q);
  snap.forEach(d => {
    const g = d.data();
    const div = document.createElement('div');
    div.className = 'group-item';
    div.textContent = g.name;
    div.onclick = () => selectChat({ type: 'group', id: d.id, name: g.name });
    groupsDiv.appendChild(div);
  });
}

window.createGroup = async () => {
  const name = document.getElementById('newGroupName').value.trim();
  if (!name) return alert('Gruppenname fehlt');
  await addDoc(collection(db, 'groups'), {
    name,
    members: [me.uid],
    created: Date.now()
  });
  loadGroups();
};

/* ================= CHAT ================= */
function selectChat(peer) {
  selectedPeer = peer;
  chatTitle.textContent = peer.name;
  chatBox.innerHTML = '';

  if (messagesUnsub) messagesUnsub();

  const q = peer.type === 'group'
    ? query(collection(db, 'messages'), where('to', '==', peer.id), orderBy('timestamp'))
    : query(collection(db, 'messages'), orderBy('timestamp'));

  messagesUnsub = onSnapshot(q, snap => {
    chatBox.innerHTML = '';
    snap.forEach(d => {
      const m = d.data();
      if (peer.type === 'user') {
        if ((m.from === me.uid && m.to === peer.id) || (m.from === peer.id && m.to === me.uid)) {
          renderMessage(m);
        }
      } else {
        renderMessage(m);
      }
    });
  });
}

function renderMessage(m) {
  const div = document.createElement('div');
  div.className = 'message';
  if (m.type === 'image') {
    const img = document.createElement('img');
    img.src = m.url;
    div.appendChild(img);
  } else {
    div.textContent = `${m.fromName || ''}: ${m.text || ''}`;
  }
  chatBox.appendChild(div);
}

window.sendMessage = async () => {
  if (!selectedPeer) return;
  const text = messageInput.value.trim();
  if (!text) return;
  await addDoc(collection(db, 'messages'), {
    from: me.uid,
    fromName: me.name,
    to: selectedPeer.id,
    text,
    timestamp: Date.now()
  });
  messageInput.value = '';
};

imageInput.addEventListener('change', e => {
  selectedFile = e.target.files[0];
  if (!selectedFile) return;
  previewImg.src = URL.createObjectURL(selectedFile);
  previewImg.style.display = 'block';
});

window.sendImage = async () => {
  if (!selectedPeer || !selectedFile) return;
  const r = ref(storage, `chat/${Date.now()}_${selectedFile.name}`);
  await uploadBytes(r, selectedFile);
  const url = await getDownloadURL(r);
  await addDoc(collection(db, 'messages'), {
    from: me.uid,
    fromName: me.name,
    to: selectedPeer.id,
    type: 'image',
    url,
    timestamp: Date.now()
  });
  selectedFile = null;
  previewImg.style.display = 'none';
  imageInput.value = '';
};

/* ================= PROFILE ================= */
window.showProfile = () => {
  alert(`Profil: ${me.name}`);
};

</script>
</body>
</html>


