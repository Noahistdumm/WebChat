<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebChat Deluxe V1.3.3</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module">
    // ==============================
    // WebChat Deluxe V1.3.3
    // ==============================

    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      orderBy,
      onSnapshot,
      serverTimestamp,
      getDocs,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // Dein Firebase-Setup
    const firebaseConfig = {
      apiKey: "DEIN_API_KEY",
      authDomain: "DEIN_AUTH_DOMAIN",
      projectId: "DEIN_PROJECT_ID",
      storageBucket: "DEIN_STORAGE_BUCKET",
      messagingSenderId: "DEIN_MSG_ID",
      appId: "DEIN_APP_ID",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentUser = null;
    let selectedPeer = null;
    let unsubscribeChat = null;

    // ========== Auth ==========
    async function signup() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      await createUserWithEmailAndPassword(auth, email, pass);
    }

    async function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      await signInWithEmailAndPassword(auth, email, pass);
    }

    async function logout() {
      await signOut(auth);
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      document.getElementById("authArea").style.display = user ? "none" : "block";
      document.getElementById("userArea").style.display = user ? "block" : "none";
      document.getElementById("chatTitle").innerText = user ? "W√§hle einen Chat" : "Bitte anmelden";
      if (user) loadContacts();
    });

    // ========== Kontakte ==========
    async function loadContacts() {
      const contactsDiv = document.getElementById("contacts");
      contactsDiv.innerHTML = "";
      const snap = await getDocs(collection(db, "users"));
      snap.forEach((d) => {
        if (d.id !== currentUser.uid) {
          const btn = document.createElement("button");
          btn.textContent = d.data().email || d.id;
          btn.onclick = () => openChat(d.id, d.data().email || d.id);
          contactsDiv.appendChild(btn);
        }
      });
    }

    async function addContactByName() {
      const name = document.getElementById("addContactInput").value.trim();
      if (!name) return;
      await setDoc(doc(db, "users", currentUser.uid), { email: currentUser.email }, { merge: true });
      document.getElementById("addContactInput").value = "";
      loadContacts();
    }

    // ========== Chat ==========
    function openChat(peerId, peerName) {
      selectedPeer = { id: peerId, name: peerName };
      document.getElementById("chatTitle").innerText = peerName;
      document.getElementById("chatBox").innerHTML = "";
      if (unsubscribeChat) unsubscribeChat();
      loadChat();
    }

    function loadChat() {
      if (!selectedPeer || !currentUser) return;
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "<p style='color:gray'>Lade Nachrichten...</p>";

      const q = query(
        collection(db, "messages"),
        where("participants", "array-contains", currentUser.uid),
        orderBy("timestamp", "asc")
      );

      unsubscribeChat = onSnapshot(q, (snapshot) => {
        chatBox.innerHTML = "";
        snapshot.forEach((docu) => {
          const msg = docu.data();
          if (
            msg.participants.includes(currentUser.uid) &&
            msg.participants.includes(selectedPeer.id)
          ) {
            const div = document.createElement("div");
            div.className = msg.from === currentUser.uid ? "message me" : "message other";
            if (msg.text) div.textContent = msg.text;
            if (msg.imageUrl) {
              const img = document.createElement("img");
              img.src = msg.imageUrl;
              img.style.maxWidth = "200px";
              img.style.borderRadius = "10px";
              div.appendChild(img);
            }
            chatBox.appendChild(div);
          }
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    }

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !selectedPeer || !currentUser) return;
      try {
        await addDoc(collection(db, "messages"), {
          from: currentUser.uid,
          to: selectedPeer.id,
          participants: [currentUser.uid, selectedPeer.id],
          text: text,
          timestamp: serverTimestamp(),
        });
        input.value = "";
      } catch (err) {
        alert("Fehler beim Senden: " + err.message);
      }
    }

    // ========== Bild senden ==========
    async function sendImage() {
      const fileInput = document.getElementById("imageInput");
      const file = fileInput.files[0];
      if (!file || !selectedPeer || !currentUser) return;

      if (file.size > 8 * 1024 * 1024) {
        alert("Bild zu gro√ü (max. 8 MB)");
        return;
      }

      const status = document.getElementById("uploadStatus");
      status.textContent = "üì§ Lade hoch...";

      const imgRef = ref(storage, `images/${Date.now()}_${file.name}`);
      try {
        await uploadBytes(imgRef, file);
        const url = await getDownloadURL(imgRef);

        await addDoc(collection(db, "messages"), {
          from: currentUser.uid,
          to: selectedPeer.id,
          participants: [currentUser.uid, selectedPeer.id],
          imageUrl: url,
          timestamp: serverTimestamp(),
        });

        status.textContent = "‚úÖ Hochgeladen";
        fileInput.value = "";
        setTimeout(() => (status.textContent = ""), 2000);
      } catch (err) {
        status.textContent = "‚ùå Fehler: " + err.message;
      }
    }

    window.signup = signup;
    window.login = login;
    window.logout = logout;
    window.addContactByName = addContactByName;
    window.openChat = openChat;
    window.sendMessage = sendMessage;
    window.sendImage = sendImage;
  </script>
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <h2>WebChat Deluxe V1.3.3</h2>

      <div id="authArea">
        <input id="email" type="email" placeholder="E-Mail"><br><br>
        <input id="password" type="password" placeholder="Passwort"><br><br>
        <button onclick="signup()">Registrieren</button>
        <button style="margin-top:8px;background:#059669" onclick="login()">Anmelden</button>
      </div>

      <div id="userArea" style="display:none;">
        <div id="userInfo"></div>
        <button style="background:#dc2626;margin-top:8px" onclick="logout()">Abmelden</button>
        <hr>
        <h4>Kontakte</h4>
        <div id="contacts"></div>
        <input id="addContactInput" placeholder="Name hinzuf√ºgen"><br>
        <button style="margin-top:6px" onclick="addContactByName()">Hinzuf√ºgen</button>
        <hr>
      </div>
    </aside>

    <main class="main">
      <header class="chat-header">
        <h3 id="chatTitle">Bitte anmelden</h3>
      </header>

      <section id="chatBox" class="chat-box"></section>

      <footer class="chat-input">
        <input id="messageInput" placeholder="Nachricht schreiben..." />
        <button onclick="sendMessage()">Senden</button>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="sendImage()">üì∑</button>
        <span id="uploadStatus" style="margin-left:8px;color:gray;font-size:0.9em;"></span>
      </footer>
    </main>
  </div>
</body>
</html>







